<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>15 Titans: Monitor & Allocation</title>
    <style>
        :root {
            /* Dark Mode Color Palette */
            --bg-color: #1e1e1e;
            --container-bg: #2d2d2d;
            --text-color: #ecf0f1;
            --input-bg: #383838;
            --input-border: #555;
            
            /* 7-Category Risk Colors */
            --agg-color: #ff6b6b;      
            --bal-agg-color: #ff9f43;  
            --bal-color: #feca57;      
            --bal-def-color: #54a0ff;  
            --def-color: #1dd1a1;      
            --crypto-color: #a55eea;   
            --cash-color: #c8d6e5;     
        }

        body { 
            font-family: 'Segoe UI', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-color);
            padding: 10px; 
            margin: 0;
        }
        .container { 
            max-width: 100%; 
            margin: 0 auto; 
            background: var(--container-bg); 
            padding: 15px; 
            border-radius: 15px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.3); 
        }
        h1 { text-align: center; color: #ecf0f1; font-weight: 800; margin-bottom: 20px; font-size: 1.5em; }

        /* --- Config Panel --- */
        .config-panel {
            background-color: #353b48; border: 1px solid #444; padding: 10px;
            border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-around; flex-wrap: wrap; gap: 5px;
        }
        .config-item { text-align: center; width: 45px; margin-bottom: 5px; }
        .config-label { font-size: 0.6em; font-weight: bold; margin-bottom: 2px; display: block; white-space: nowrap; }
        .config-dynamic { font-size: 0.6em; color: #b2bec3; font-weight: 600; display: block; margin-top: 2px; }
        
        .alloc-input {
            width: 100%; padding: 2px; text-align: center; 
            background-color: var(--input-bg); border: 1px solid var(--input-border); color: white;
            border-radius: 4px; font-weight: bold; font-size: 0.9em;
        }

        /* Color mappings */
        .c-agg { color: var(--agg-color); }
        .c-bal-agg { color: var(--bal-agg-color); }
        .c-bal { color: var(--bal-color); }
        .c-bal-def { color: var(--bal-def-color); }
        .c-def { color: var(--def-color); }
        .c-cry { color: var(--crypto-color); }
        .c-cash { color: var(--cash-color); }
        .text-danger { color: #ff6b6b !important; font-weight: 800; }

        /* --- Deposit Section --- */
        .deposit-area {
            display: flex; justify-content: center; align-items: center; gap: 10px; margin-bottom: 15px;
            background: #353b48; padding: 10px; border-radius: 10px;
        }
        .deposit-area label { font-weight: bold; color: #dfe6e9; font-size: 0.9em; }
        .deposit-area input {
            padding: 8px; width: 120px; text-align: right; font-size: 1.1em; 
            background: var(--input-bg); border: 1px solid var(--input-border); color: #ffeaa7; border-radius: 5px;
        }

        /* --- Table Styling (Mobile Optimized) --- */
        .table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.8em; margin-top: 5px; min-width: 600px; }
        thead tr { background-color: #2c3e50; color: #dfe6e9; text-align: center; }
        th, td { padding: 8px 4px; border-bottom: 1px solid #444; text-align: center; vertical-align: middle; }
        
        input[type="text"], input[type="number"], select { 
            padding: 4px; background: var(--input-bg); border: 1px solid var(--input-border); 
            color: #ecf0f1; border-radius: 4px; text-align: center; font-weight: 600; width: 90%;
        }
        
        .status-badge { padding: 3px 6px; border-radius: 10px; color: white; font-weight: bold; font-size: 0.7em; display: inline-block; }
        .bg-green { background-color: #27ae60; }
        .bg-yellow { background-color: #f1c40f; color: #2d3436; }
        .bg-red { background-color: #e74c3c; animation: blink 1.5s infinite; }
        @keyframes blink { 50% { opacity: 0.6; } }

        .buy-amt { color: #ff7675; font-weight: 800; font-size: 1.1em; }
        .rank-txt { font-weight: bold; font-size: 1.2em; }

        /* Action Buttons */
        .btn-area { display: flex; justify-content: center; gap: 10px; margin-top: 20px; padding: 10px; background: #353b48; border-radius: 10px;}
        button { padding: 10px 15px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; color: white; font-size: 0.9em; }
        
        .btn-refresh { background-color: #3498db; }
        .btn-calc { background-color: #9b59b6; }
        
        .footer-note { margin-top: 20px; font-size: 0.7em; color: #7f8c8d; text-align: center; }
    </style>
</head>
<body>

<div class="container">
    <h1>üì° 15 Titans Dashboard</h1>

    <div class="config-panel">
        <div class="config-item"><label class="config-label c-agg">Agg</label><input type="number" id="targetAgg" class="alloc-input" value="30" oninput="distributeWeights()"><span class="config-dynamic" id="realAgg">0%</span></div>
        <div class="config-item"><label class="config-label c-bal-agg">BalAgg</label><input type="number" id="targetBalAgg" class="alloc-input" value="20" oninput="distributeWeights()"><span class="config-dynamic" id="realBalAgg">0%</span></div>
        <div class="config-item"><label class="config-label c-bal">Bal</label><input type="number" id="targetBal" class="alloc-input" value="15" oninput="distributeWeights()"><span class="config-dynamic" id="realBal">0%</span></div>
        <div class="config-item"><label class="config-label c-bal-def">BalDef</label><input type="number" id="targetBalDef" class="alloc-input" value="10" oninput="distributeWeights()"><span class="config-dynamic" id="realBalDef">0%</span></div>
        <div class="config-item"><label class="config-label c-def">Def</label><input type="number" id="targetDef" class="alloc-input" value="10" oninput="distributeWeights()"><span class="config-dynamic" id="realDef">0%</span></div>
        <div class="config-item"><label class="config-label c-cry">Cry</label><input type="number" id="targetCry" class="alloc-input" value="10" oninput="distributeWeights()"><span class="config-dynamic" id="realCry">0%</span></div>
        <div class="config-item"><label class="config-label c-cash">Cash</label><input type="number" id="targetCash" class="alloc-input" value="5" oninput="distributeWeights()"><span class="config-dynamic" id="realCash">0%</span></div>
        <div class="config-item"><label class="config-label" style="color:#bdc3c7">Sum</label><span id="targetSumCheck" style="font-size:1em; font-weight:bold; color:#2ecc71; display:block; margin-top:5px;">100%</span></div>
    </div>

    <div class="deposit-area">
        <label>üí∞ Total ($):</label>
        <input type="number" id="totalInvest" value="10000" oninput="checkRealAllocations()">
    </div>

    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th width="8%">Group</th>
                    <th width="8%">Ticker</th>
                    <th width="15%">Competitor</th>
                    <th width="5%">Rk</th>
                    <th width="7%">Gap%</th>
                    <th width="10%">Status</th>
                    <th width="8%" style="background:#2c3e50; color:#bdc3c7;">Wgt%</th>
                    <th width="12%" style="background:#2c3e50; color:#bdc3c7;">Buy($)</th>
                    <th width="10%">My Val</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div class="btn-area">
        <button class="btn-calc" onclick="distributeWeights()">‚öñÔ∏è Auto-Balance</button>
        <button class="btn-refresh" onclick="location.reload()">üîÑ Refresh</button>
    </div>
    
    <div class="footer-note">
        Data is updated daily via GitHub Actions.<br>
        To add tickers, edit 'portfolio.json' in GitHub.
    </div>
</div>

<script>
    let portfolioData = [];
    const CATEGORIES = ['Agg', 'Bal-Agg', 'Bal', 'Bal-Def', 'Def', 'Crypto', 'Cash'];

    async function loadData() {
        // Ï∫êÏã± Î∞©ÏßÄ: URL Îí§Ïóê ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ Ï∂îÍ∞Ä
        try {
            const res = await fetch('portfolio.json?t=' + new Date().getTime());
            if (!res.ok) throw new Error("Network response was not ok");
            portfolioData = await res.json();
            
            // Î°úÏª¨ Ïä§ÌÜ†Î¶¨ÏßÄÏóêÏÑú 'My Value'ÏôÄ 'Settings' Î∂àÎü¨Ïò§Í∏∞
            loadLocalSettings();
            
            renderTable();
            checkRealAllocations();
        } catch (e) {
            console.error("Failed to load data", e);
            document.querySelector('.container').innerHTML += `<p style="color:red; text-align:center;">Failed to load portfolio.json. Check GitHub Actions.</p>`;
        }
    }

    function renderTable() {
        const tbody = document.getElementById('tableBody');
        tbody.innerHTML = '';
        const totalMoney = parseFloat(document.getElementById('totalInvest').value) || 0;

        portfolioData.forEach((item, index) => {
            const row = document.createElement('tr');
            
            let badgeClass = 'bg-green';
            if(item.status === 'Yellow') badgeClass = 'bg-yellow';
            if(item.status === 'Red') badgeClass = 'bg-red';

            const gapStr = item.gap ? `${item.gap}%` : '-';
            const competitor = item.competitor ? item.competitor.split('.')[1] || item.competitor : '-'; // Ïù¥Î¶ÑÎßå ÏßßÍ≤å
            
            let rankColor = '#bdc3c7'; 
            if (item.rank > 3) rankColor = '#e74c3c';

            // Group Color Logic
            let groupColor = '#ecf0f1';
            const g = (item.group || 'Agg'); 
            if(g === 'Agg') groupColor = 'var(--agg-color)';
            else if(g === 'Bal-Agg') groupColor = 'var(--bal-agg-color)';
            else if(g === 'Bal') groupColor = 'var(--bal-color)';
            else if(g === 'Bal-Def') groupColor = 'var(--bal-def-color)';
            else if(g === 'Def') groupColor = 'var(--def-color)';
            else if(g === 'Crypto') groupColor = 'var(--crypto-color)';
            else if(g === 'Cash') groupColor = 'var(--cash-color)';

            const wgt = parseFloat(item.weight) || 0;
            const toBuy = totalMoney * (wgt / 100);

            row.innerHTML = `
                <td style="color:${groupColor}; font-weight:bold;">${item.group}</td>
                <td style="font-weight:bold;">${item.ticker}</td>
                <td style="color:#95a5a6; font-size:0.9em;">${competitor}</td>
                <td class="rank-txt" style="color:${rankColor};">${item.rank || '-'}</td>
                <td style="color:${item.gap < 10 && item.gap > 0 ? '#ff7675' : '#55efc4'}">${gapStr}</td>
                <td><span class="status-badge ${badgeClass}">${item.status}</span></td>
                <td><input type="number" step="0.1" style="color:#74b9ff;" value="${wgt.toFixed(1)}" onchange="updateWeight(${index}, this.value)"></td>
                <td class="buy-amt">$${toBuy.toLocaleString(undefined, {maximumFractionDigits: 0})}</td>
                <td><input type="number" value="${item.myValue || 0}" onchange="updateMyValue(${index}, this.value)"></td>
            `;
            tbody.appendChild(row);
        });
    }

    // --- Logic & Events ---
    
    function distributeWeights() {
        const targets = getTargetSettings();
        saveLocalSettings(); // ÏÑ§Ï†ï Ï†ÄÏû•
        updateTotalCheck(targets);

        const counts = { Agg:0, 'Bal-Agg':0, Bal:0, 'Bal-Def':0, Def:0, Crypto:0, Cash:0 };
        portfolioData.forEach(item => { if(counts[item.group] !== undefined) counts[item.group]++; });

        let activeSum = 0;
        for (let k in counts) { if (counts[k] > 0) activeSum += targets[k]; }
        const multiplier = activeSum > 0 ? (100 / activeSum) : 0;

        portfolioData.forEach(item => {
            const g = item.group;
            if (counts[g] > 0) {
                const groupRealAlloc = targets[g] * multiplier;
                item.weight = groupRealAlloc / counts[g]; 
            } else {
                item.weight = 0;
            }
        });
        
        renderTable(); 
        checkRealAllocations();
    }

    function updateWeight(index, val) {
        portfolioData[index].weight = parseFloat(val) || 0;
        renderTable(); // Re-render to update amounts
        checkRealAllocations();
    }

    function updateMyValue(index, val) {
        portfolioData[index].myValue = parseFloat(val) || 0;
        saveLocalSettings(); // Í∞í Î≥ÄÍ≤Ω Ïãú Î°úÏª¨ Ï†ÄÏû•
    }

    function checkRealAllocations() {
        const targets = getTargetSettings();
        const sums = { Agg:0, 'Bal-Agg':0, Bal:0, 'Bal-Def':0, Def:0, Crypto:0, Cash:0 };

        portfolioData.forEach(item => {
            if(sums[item.group] !== undefined) {
                sums[item.group] += (parseFloat(item.weight) || 0);
            }
        });

        // Header Update
        for(let k in sums) {
            const elId = 'real' + k.replace('-', ''); // Bal-Agg -> realBalAgg
            const el = document.getElementById(elId);
            if(el) {
                el.innerText = sums[k].toFixed(1) + '%';
                if (sums[k] > targets[k] + 0.1) el.classList.add('text-danger');
                else el.classList.remove('text-danger');
            }
        }
    }

    function getTargetSettings() {
        return {
            Agg: parseFloat(document.getElementById('targetAgg').value) || 0,
            'Bal-Agg': parseFloat(document.getElementById('targetBalAgg').value) || 0,
            Bal: parseFloat(document.getElementById('targetBal').value) || 0,
            'Bal-Def': parseFloat(document.getElementById('targetBalDef').value) || 0,
            Def: parseFloat(document.getElementById('targetDef').value) || 0,
            Crypto: parseFloat(document.getElementById('targetCry').value) || 0,
            Cash: parseFloat(document.getElementById('targetCash').value) || 0
        };
    }

    function updateTotalCheck(targets) {
        let sum = 0;
        for (let k in targets) sum += targets[k];
        const checkEl = document.getElementById('targetSumCheck');
        checkEl.innerText = sum + '%';
        checkEl.style.color = sum === 100 ? '#2ecc71' : '#e74c3c';
    }

    // --- Local Storage (Phone Persistence) ---
    function saveLocalSettings() {
        const settings = getTargetSettings();
        const myValues = portfolioData.map(p => ({ t: p.ticker, v: p.myValue }));
        const totalInv = document.getElementById('totalInvest').value;
        
        localStorage.setItem('titans_settings', JSON.stringify(settings));
        localStorage.setItem('titans_values', JSON.stringify(myValues));
        localStorage.setItem('titans_total', totalInv);
    }

    function loadLocalSettings() {
        const savedSettings = localStorage.getItem('titans_settings');
        const savedValues = localStorage.getItem('titans_values');
        const savedTotal = localStorage.getItem('titans_total');

        if(savedTotal) document.getElementById('totalInvest').value = savedTotal;

        if (savedSettings) {
            const s = JSON.parse(savedSettings);
            document.getElementById('targetAgg').value = s.Agg;
            document.getElementById('targetBalAgg').value = s['Bal-Agg'];
            document.getElementById('targetBal').value = s.Bal;
            document.getElementById('targetBalDef').value = s['Bal-Def'];
            document.getElementById('targetDef').value = s.Def;
            document.getElementById('targetCry').value = s.Crypto;
            document.getElementById('targetCash').value = s.Cash;
        }

        if (savedValues) {
            const vals = JSON.parse(savedValues);
            // Îß§Ïπ≠ÎêòÎäî Ìã∞Ïª§Ïùò myValue Î≥µÏõê
            portfolioData.forEach(p => {
                const found = vals.find(v => v.t === p.ticker);
                if(found) p.myValue = found.v;
            });
        }
    }

    // Ï¥àÍ∏∞ Ïã§Ìñâ
    loadData();
</script>

</body>
</html>